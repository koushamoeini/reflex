# Grade PR (run only): build, run official tests, grade, upload artifact.
# Does NOT comment on PR. Use grade-comment.yml (workflow_run) to post the comment
# so that fork PRs get comments too (workflow_run runs with base-repo token).
name: Grade PR (run)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: grade-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  build-test:
    runs-on: ubuntu-latest
    outputs:
      build_ok: ${{ steps.out.outputs.build_ok }}
      test_pass: ${{ steps.out.outputs.test_pass }}
      coverage_pct: ${{ steps.out.outputs.coverage_pct }}
      lint_pass: ${{ steps.out.outputs.lint_pass }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore official tests and grading from base branch
        run: |
          git fetch origin "${{ github.base_ref || 'main' }}"
          git checkout origin/"${{ github.base_ref || 'main' }}" -- xray-core/proxy/reflex/grading/ 2>/dev/null || true
          git checkout origin/"${{ github.base_ref || 'main' }}" -- xray-core/tests/ 2>/dev/null || true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: xray-core/go.mod
          cache-dependency-path: xray-core/go.sum

      - name: Init resources
        run: |
          mkdir -p xray-core/resources
          [ -s xray-core/resources/geoip.dat ] || touch xray-core/resources/geoip.dat
          [ -s xray-core/resources/geosite.dat ] || touch xray-core/resources/geosite.dat

      - name: Build
        id: build
        working-directory: xray-core
        run: |
          if go build -o xray ./main 2>/dev/null; then
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Test
        id: test
        working-directory: xray-core
        run: |
          pass=false
          if [ -d proxy/reflex ]; then
            go test -timeout 5m -coverprofile=coverage.out -covermode=atomic -json ./proxy/reflex/... ./tests/... > test_result.json 2>&1; ec=$?
          else
            go test -timeout 2m -coverprofile=coverage.out -covermode=atomic -json ./tests/... > test_result.json 2>&1; ec=$?
          fi
          [ $ec -eq 0 ] && pass=true
          [ -f coverage.out ] || touch coverage.out
          [ -f test_result.json ] || echo '[]' > test_result.json
          echo "pass=$pass" >> $GITHUB_OUTPUT

      - name: Coverage
        id: coverage
        working-directory: xray-core
        run: |
          if [ -f coverage.out ]; then
            pct=$(go tool cover -func=coverage.out 2>/dev/null | grep total | awk '{print int($3)}')
            echo "pct=${pct:-0}" >> $GITHUB_OUTPUT
          else
            echo "pct=0" >> $GITHUB_OUTPUT
          fi

      - name: Lint
        id: lint
        uses: golangci/golangci-lint-action@v5
        with:
          version: v1.55.2
          working-directory: xray-core
          args: --timeout=5m
        continue-on-error: true

      - name: Set outputs
        id: out
        run: |
          echo "build_ok=${{ steps.build.outputs.ok }}" >> $GITHUB_OUTPUT
          echo "test_pass=${{ steps.test.outputs.pass }}" >> $GITHUB_OUTPUT
          echo "coverage_pct=${{ steps.coverage.outputs.pct }}" >> $GITHUB_OUTPUT
          echo "lint_pass=${{ steps.lint.outcome == 'success' }}" >> $GITHUB_OUTPUT

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: xray-core/coverage.out
        if: always()

      - name: Upload test result
        uses: actions/upload-artifact@v4
        with:
          name: test-result
          path: xray-core/test_result.json
        if: always()

  grade:
    needs: [build-test]
    if: always() && needs.build-test.result != 'cancelled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore official grading script from base branch
        run: |
          git fetch origin "${{ github.base_ref || 'main' }}"
          git show origin/"${{ github.base_ref || 'main' }}":.github/scripts/grade-reflex.sh > .github/scripts/grade-reflex.sh 2>/dev/null || true

      - name: Download test result
        uses: actions/download-artifact@v4
        with:
          name: test-result
        continue-on-error: true

      - name: Ensure test result path for grading script
        run: |
          if [ -f test-result/xray-core/test_result.json ] && [ ! -f xray-core/test_result.json ]; then
            mkdir -p xray-core
            cp test-result/xray-core/test_result.json xray-core/test_result.json
          fi
          if [ -f test-result/test_result.json ] && [ ! -f xray-core/test_result.json ]; then
            mkdir -p xray-core
            cp test-result/test_result.json xray-core/test_result.json
          fi

      - name: Install jq
        run: sudo apt-get update -qq && sudo apt-get install -y -qq jq

      - name: Extract student IDs
        id: extract
        run: |
          ids=""
          if [ -f README.md ]; then
            ids=$(grep -E '^\s*[-*]\s+[0-9]{8,}\s+[—\-]' README.md 2>/dev/null | grep -oE '[0-9]{8,}' | sort -u | tr '\n' ',' | sed 's/,$//')
          fi
          if [ -n "$ids" ]; then
            id="$ids"
          else
            BRANCH="${{ github.head_ref || 'main' }}"
            BODY="${{ github.event.pull_request.body || '' }}"
            if echo "$BRANCH" | grep -qE 'student-([0-9]+)|.*-([0-9]{8,})'; then
              id=$(echo "$BRANCH" | grep -oE '[0-9]{8,}' | head -1)
            elif echo "$BODY" | grep -qiE 'student id[ \t:]+[0-9]+|شماره دانشجویی[ \t:]+[0-9]+'; then
              id=$(echo "$BODY" | grep -oiE 'student id[ \t:]+[0-9]+|شماره دانشجویی[ \t:]+[0-9]+' | grep -oE '[0-9]+' | head -1)
            elif [ -f README.md ]; then
              id=$(grep -iE 'شماره دانشجویی|student id' README.md 2>/dev/null | grep -oE '[0-9]{8,}' | head -1)
            else
              id="unknown"
            fi
          fi
          echo "id=${id:-unknown}" >> $GITHUB_OUTPUT

      - name: Grade
        id: grade
        env:
          BUILD_OK: ${{ needs.build-test.outputs.build_ok }}
          TEST_PASS: ${{ needs.build-test.outputs.test_pass }}
          COVERAGE_PCT: ${{ needs.build-test.outputs.coverage_pct }}
          LINT_PASS: ${{ needs.build-test.outputs.lint_pass }}
          STUDENT_ID: ${{ steps.extract.outputs.id }}
          TEST_RESULT_JSON: xray-core/test_result.json
        run: |
          chmod +x .github/scripts/grade-reflex.sh
          ./.github/scripts/grade-reflex.sh > grades.json 2>/dev/null || true
          if ! jq -e '.totalMax == 105 and .total >= 0 and .total <= 105' grades.json >/dev/null 2>&1; then
            echo '{"studentId":"unknown","step1":0,"step2":0,"step3":0,"step4":0,"step5":0,"unitTest":0,"integration":0,"cleanCode":0,"report":0,"total":0,"totalMax":105,"buildOk":false,"testsPass":false,"lintPass":false,"coverage":0,"gradingMode":"fallback"}' > grades.json
          fi

      - name: Save PR number for comment workflow
        run: echo '${{ github.event.pull_request.number }}' > pr_number.txt

      - name: Upload grades artifact
        uses: actions/upload-artifact@v4
        with:
          name: grades-output
          path: |
            grades.json
            pr_number.txt
